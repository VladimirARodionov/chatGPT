# Бот ChatGPT с транскрибацией аудио

Telegram-бот, который позволяет общаться с ChatGPT и транскрибировать аудиосообщения с помощью OpenAI Whisper.

## Функциональность

- Обмен текстовыми сообщениями с ChatGPT
- Транскрибация голосовых сообщений и аудиофайлов с помощью:
  - Локальной модели Whisper (https://github.com/openai/whisper)
  - API OpenAI (whisper-1)
- Неблокирующая обработка аудио с использованием асинхронной очереди задач
- Сохранение транскрибаций в текстовые файлы с возможностью скачивания
- Кеширование моделей Whisper для использования между перезапусками
- Удобное главное меню с доступом ко всем командам
- Ограничение в 50 сообщений на пользователя в сутки
- Сохранение статистики использования в базе данных PostgreSQL
- Поддержка Local Bot API Server для работы с файлами размером до 2 ГБ

## Ограничения

- **Максимальный размер аудиофайла**: 
  - 20 МБ (стандартный Telegram Bot API)
  - 2000 МБ / 2 ГБ (с использованием Local Bot API Server)
- Максимальная длина сообщения: 4096 символов (ограничение Telegram)
- Максимальная длина подписи к файлу: 1024 символа

## Установка и запуск

### Запуск с использованием Docker (рекомендуется)

1. Клонировать репозиторий:
```bash
git clone <repository_url>
cd <repository_folder>
```

2. Создать файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

3. Заполнить необходимые переменные в файле `.env`:
   - `TELEGRAM_TOKEN` - токен бота Telegram (получить у @BotFather)
   - `OPEN_AI_TOKEN` - API ключ OpenAI
   - `API_ID` и `API_HASH` - данные для Telegram API (получить на my.telegram.org)

4. Запустить контейнеры с помощью Docker Compose:
```bash
docker-compose up -d
```

5. Проверить логи:
```bash
docker-compose logs -f
```

### Установка без Docker

1. Клонировать репозиторий:
```bash
git clone <repository_url>
cd <repository_folder>
```

2. Установить зависимости:
```bash
pip install -r requirements.txt
```

3. Установить FFmpeg (необходим для обработки аудио):
   - **Windows**: Скачать с [ffmpeg.org](https://ffmpeg.org/download.html) и добавить в PATH
   - **Linux**: `sudo apt-get install ffmpeg`
   - **MacOS**: `brew install ffmpeg`

4. Создать файл .env со следующими параметрами:
```
TELEGRAM_TOKEN=<your_telegram_bot_token>
OPEN_AI_TOKEN=<your_openai_api_key>
MODEL=gpt-3.5-turbo
POSTGRES_USER=<database_user>
POSTGRES_PASSWORD=<database_password>
POSTGRES_DB=<database_name>
POSTGRES_PORT=5432
USE_LOCAL_WHISPER=True
WHISPER_MODEL=base
WHISPER_MODELS_DIR=whisper_models
```

5. Настроить базу данных PostgreSQL и запустить миграции:
```bash
alembic upgrade head
```

6. Запустить бота:
```bash
python bot.py
```

## Настройка Local Bot API Server для больших файлов

Для работы с большими аудиофайлами (до 2 ГБ) бот поддерживает [Local Bot API Server](https://core.telegram.org/bots/api#using-a-local-bot-api-server).

### Запуск с Docker Compose (автоматическая настройка)

При запуске через `docker-compose up -d`, сервер Local Bot API будет настроен автоматически. 
Необходимо указать в файле `.env` следующие параметры:

```
API_ID=your_api_id_here         # Получить на my.telegram.org
API_HASH=your_api_hash_here     # Получить на my.telegram.org
LOCAL_BOT_API=http://telegram-bot-api:8081
```

### Ручная настройка без Docker

Для ручной настройки Local Bot API Server следуйте инструкциям в файле [local_bot_api_guide.md](local_bot_api_guide.md).

## Доступные модели Whisper

| Размер  | Параметры | Только английский | Мультиязычная модель | Требуемая VRAM | Относит. скорость |
|---------|-----------|-------------------|----------------------|----------------|-------------------|
| tiny    | 39M       | tiny.en           | tiny                 | ~1 GB          | ~10x              |
| base    | 74M       | base.en           | base                 | ~1 GB          | ~7x               |
| small   | 244M      | small.en          | small                | ~2 GB          | ~4x               |
| medium  | 769M      | medium.en         | medium               | ~5 GB          | ~2x               |
| large   | 1550M     | N/A               | large                | ~10 GB         | 1x                |
| turbo   | 809M      | N/A               | turbo                | ~6 GB          | ~8x               |

Для русского языка рекомендуется использовать мультиязычные модели.

## Команды бота

- `/start` - Начать общение с ботом
- `/menu` - Показать главное меню
- `/status` - Проверить лимит сообщений на сегодня
- `/models` - Показать список скачанных моделей Whisper
- `/help` - Показать справку

## Использование

1. Отправьте текстовое сообщение боту для получения ответа от ChatGPT
2. Отправьте голосовое сообщение или аудиофайл для транскрибации:
   - Бот поставит аудиофайл в очередь и сразу освободится для обработки других запросов
   - Во время транскрибации аудио вы можете продолжать общение с ботом
   - Когда транскрибация будет готова, бот отправит вам результат
   - Файлы транскрибаций сохраняются в директории `transcriptions/`
   - **Важно**: При использовании стандартного Telegram Bot API, аудио должно быть не более 20 МБ
   - **Важно**: При использовании Local Bot API Server, аудио может быть до 2 ГБ

## Структура директорий

- `temp_audio/` - временная директория для сохранения аудиофайлов
- `transcriptions/` - директория для сохранения файлов с транскрибацией
- `whisper_models/` - директория для хранения скачанных моделей Whisper
- `alembic_migrations/` - миграции базы данных Alembic
- `logs/` - директория для логов приложения и Bot API Server

## Устранение проблем

### Ограничения размера файлов в Telegram

Несмотря на использование Local Bot API Server, существуют некоторые операции, для которых Telegram всё равно применяет стандартное ограничение в 20 МБ:

- **Фактическое ограничение**: 20 МБ для большинства операций с файлами
- **Теоретический предел с Local Bot API**: 2000 МБ (2 ГБ)

#### Технические ограничения Telegram API

1. **Стандартное ограничение**:
   - Для стандартного Telegram Bot API максимальный размер файла составляет 20 МБ
   - Это ограничение применяется к большинству операций с файлами

2. **Local Bot API Server**:
   - Теоретически поддерживает файлы до 2 ГБ
   - Однако некоторые методы API все равно ограничены 20 МБ
   - Особенно это касается получения информации о файле и первичной обработки

3. **Реальное поведение**:
   - Файлы размером 0-19 МБ: обрабатываются без проблем
   - Файлы размером 20-30 МБ: могут вызывать ошибки даже при использовании Local Bot API
   - Файлы размером более 30 МБ: требуют специальных методов загрузки

### Рекомендации для работы с большими аудиофайлами

1. **Оптимальные форматы и размеры**:
   - Используйте MP3 вместо WAV или FLAC (меньший размер при той же длительности)
   - Оптимальный битрейт для речи: 96-128 kbps (хорошее качество при небольшом размере)
   - Идеальный размер файла: до 19 МБ

2. **Сжатие и конвертация**:
   - Для Windows: [Audacity](https://www.audacityteam.org/) (бесплатно)
   - Для macOS: [FFmpeg](https://ffmpeg.org/) или [iTunes](https://www.apple.com/itunes/)
   - Онлайн: [Online Audio Converter](https://online-audio-converter.com/)

3. **Разделение длинных аудиозаписей**:
   - Разделяйте файлы на части по 8-10 минут
   - Используйте специальные инструменты для разделения (Audacity, FFmpeg)
   - Номеруйте части последовательно (часть1, часть2 и т.д.)

4. **Команда для сжатия с помощью FFmpeg**:
   ```bash
   ffmpeg -i input.wav -codec:a libmp3lame -qscale:a 5 output.mp3
   ```

### Ошибка "file is too big"

Если вы получаете ошибку "Telegram server says - Bad Request: file is too big", это означает, что размер файла превышает ограничение Telegram Bot API в 20 МБ. Решения:

1. Используйте аудиофайл меньшего размера
2. Сократите длительность аудио
3. Разделите длинное аудио на несколько частей
4. Настройте Local Bot API Server как описано выше для обработки файлов до 2 ГБ

### Проблемы с правами доступа в Docker

Если вы получаете ошибку "Permission denied" при работе с файлами в Docker, это связано с неправильными правами доступа к директориям. 

#### Быстрое решение (без перезапуска)

1. Выполните скрипт для исправления прав доступа:
```bash
chmod +x fix_permissions.sh
./fix_permissions.sh
```

2. Скрипт найдет контейнер приложения, исправит права доступа внутри него и перезапустит контейнер.

#### Полное решение (с перезапуском)

1. Остановите и удалите текущие контейнеры:
```bash
docker-compose down
```

2. Пересоберите образы и запустите контейнеры заново:
```bash
docker-compose up -d --build
```

3. Проверьте логи, чтобы убедиться, что проблема устранена:
```bash
docker-compose logs -f chatgptapp
```

### Проблемы с запуском Telegram Bot API Server

Если у вас возникают проблемы с запуском контейнера telegram-bot-api и вы видите ошибку "dependency failed to start: container chatgpt-telegram-bot-api-1 is unhealthy", выполните следующие шаги для диагностики и устранения проблемы:

#### Диагностика проблемы

1. Запустите скрипт диагностики для API сервера:
```bash
chmod +x fix_api_server.sh
./fix_api_server.sh
```

2. Проверьте логи API сервера для получения дополнительной информации:
```bash
docker-compose logs telegram-bot-api
```

#### Распространенные причины и их решения:

1. **Неверные API_ID и API_HASH**
   - Убедитесь, что в файле `.env` корректно указаны API_ID и API_HASH от Telegram
   - Эти данные можно получить на сайте [my.telegram.org](https://my.telegram.org)

2. **Порт уже занят другим приложением**
   - Измените порт в файле `.env`, например:
   ```
   API_PORT=8083
   LOCAL_BOT_API=http://telegram-bot-api:8083
   ```

3. **Проблемы с директориями для логов и данных**
   - Создайте необходимые директории вручную:
   ```bash
   mkdir -p logs/telegram-bot-api
   chmod -R 777 logs/telegram-bot-api
   ```

#### Полная перенастройка API сервера

Если проблемы сохраняются, выполните полную перенастройку:

```bash
# Остановить и удалить все контейнеры и тома
docker-compose down -v

# Пересобрать образы без использования кеша
docker-compose build --no-cache

# Запустить все сервисы
docker-compose up -d
```

### Проверка прав доступа вручную

Если проблемы с правами доступа сохраняются, вы можете проверить права доступа внутри контейнера:

```bash
# Получите ID контейнера
docker ps

# Запустите оболочку внутри контейнера
docker exec -it <container_id> bash

# Проверьте права доступа
ls -la /app/temp_audio
ls -la /app/transcriptions
```

Все директории должны иметь права на чтение и запись для пользователя `app` (755 или 777).

## Технические особенности

### Асинхронная обработка аудио

Бот использует асинхронную обработку аудиофайлов для предотвращения блокировки:

- **Очередь задач**: Все запросы на транскрибацию аудио помещаются в очередь
- **Фоновая обработка**: Транскрибация выполняется в отдельном потоке
- **Многозадачность**: Во время обработки аудио бот продолжает реагировать на другие команды
- **Уведомления**: Пользователь получает уведомление, когда транскрибация готова

Это особенно полезно при обработке длинных аудиофайлов, когда транскрибация может занимать значительное время.

### Масштабируемость

- Количество одновременно обрабатываемых аудиофайлов контролируется переменной `max_workers` в ThreadPoolExecutor
- При необходимости можно увеличить это значение для улучшения производительности на мощных серверах
- Docker-контейнеры позволяют легко масштабировать решение горизонтально
